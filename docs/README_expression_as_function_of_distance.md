# Expression as a Function of Distance (`insituprep expression-distance`)

This document describes the **Expression as a Function of Distance** analysis implemented in the `insituprep` package.
The goal of this analysis is to identify genes whose expression in a given cell type
(**primary cell type**) correlates with spatial distance to another cell type
(**neighbor cell type**) within a tissue.

The analysis is designed for spatial transcriptomics data and combines:
- Euclidean distance computation from primary to neighbor cells
- Low Expression Gene (LEG) filtering
- Linear regression of gene expression on distance
- Permutation-based statistical validation
- Global FDR correction (Benjamini–Hochberg)
- Gaussian-smoothed R² filtering

To view the full list of command-line options and defaults, run:

```bash
insituprep expression-distance --help
```
The pipeline is implemented as an insituprep CLI command.
---

## Conceptual overview: what this analysis does and why

For a selected tissue, the analysis proceeds as follows:

1. **Select a tissue**
    - Only cells belonging to the requested tissue are analyzed.
    - The analysis can be restricted to one or more tissues using the `--tissue` argument.
    - If `--tissue` is not provided, the analysis runs on **all tissues** present in the data.

2. **Define primary and neighbor cell types**
    - Primary cells are the cells whose gene expression will be tested.
    - Neighbor cells define the spatial context.

3. **Compute minimum distances**
    - For each primary cell, the Euclidean distance to the nearest neighbor cell is calculated.
    - Distances exceeding a maximum threshold (µm) are excluded from analysis.
    - This converts spatial information into a continuous variable suitable for regression.

4. **Low Expression Gene (LEG) filtering**
    - Genes with low expression (98th percentile ≤ threshold) or few expressing cells are removed.
    - This step reduces noise from genes with minimal signal.

5. **Linear regression analysis**
    - Gene expression in primary cells is regressed against their minimum distance to neighbor cells.
    - This tests whether proximity to the neighbor cell type is associated with monotonic changes in gene expression.
    - Slope, R², and p-values are computed for each gene.
    
6. **Permutation-based significance assessment**
    - Distance labels are randomly shuffled multiple times.
    - Linear regression is re-run on permuted data to generate empirical p-values.
    - This reflects how often a randomized spatial configuration produces an effect as strong as, or stronger than, the observed one.

7. **Global FDR correction**
    - False discovery rate (Benjamini–Hochberg) is applied across all genes, tissues, and cell-type pairs.
    - Only genes meeting the FDR threshold are retained.

8. **Gaussian-smoothed R² filtering**
    - Expression values are smoothed using a Gaussian filter (user-defined σ parameter).
    - R² is recomputed on smoothed data to identify genes with robust distance-dependent trends.
    - Genes with R² below the threshold are removed.

9. **Results are written to disk**
    - A combined table describing all analyzed cell-type pairs and genes
    - Heatmaps of regression features (slope, FDR, R²) by tissue
    - Multi-panel expression-distance plots for each significant gene

---

## Filtering logic

During distance computation, linear regression, and permutation testing, genes are filtered in several steps to retain only robust and biologically meaningful signals.

The filtering procedure is as follows:

1. **Low Expression Gene (LEG) filtering**  
    For each primary cell type and tissue:
    - Genes are removed if their 98th percentile expression ≤ `--leg-threshold`
    - Genes are removed if fewer than `--cell-count-threshold` cells express them
    - This step reduces noise from genes with minimal detectability.

2. **Linear regression**  
    For each gene:
    - Slope, R², and nominal p-value are computed via linear regression of expression on minimum distance.
    - Permutation-based p-values are generated by shuffling distance labels and re-fitting.

3. **Global FDR correction**  
    - Benjamini–Hochberg FDR adjustment is applied across all genes, tissues, and cell-type pairs.
    - Only genes with FDR-adjusted p-value ≤ `--fdr-thresh` are retained.

4. **Gaussian-smoothed R² filtering**  
    - Expression values are smoothed using a Gaussian filter with σ = `--sigma-param`.
    - R² is recomputed on smoothed data.
    - Genes with R² < `--r2-threshold` are removed.
    - This step ensures that retained genes show robust, smooth distance-dependent trends.

---

## Input files

### 1) Summary table file path (`--summary-table-path`) (required)

CSV with per-cell metadata and gene expression counts from all tissues.

**Requirements:**
- Required columns:
  - `Var1` (cell IDs)
  - `tissue` (string tissue identifier. Even if the CSV stores tissue as numeric, the tool loads and treats it as string)
  - `cell_type` (string)
- Should include gene expression columns (one column per gene, numeric raw counts)
- Required coordinates:
  - `X_space`, `Y_space` (cell centroid coordinates in µm)
  - `Z_space` (optional, for 3D analysis)

Example:

| Var1       | cell_type        | tissue | X_space        | Y_space        | Z_space        | ACTA2 | ACTG2 | ACTR3B | ADGRL4 |
|------------|------------------|--------|----------------|----------------|----------------|-------|-------|--------|--------|
| 100.26.007 | B                | 100    | 182.5507909    | 48.5805818     | 4.4420121      | 0     | 0     | 0      | 0      |
| 982.14.016 | Endothelial      | 982    | 149.6374364    | 70.9100727     | 7.3111273      | 4     | 0     | 0      | 0      |
| 313.76.019 | Epithelial       | 313    | 140.4967091    | 76.4971091     | 6.6119515      | 0     | 0     | 1      | 0      |
| 100.1.056  | T_CD3            | 100    | 121.1400273    | 36.8719009     | 4.2549212      | 1     | 0     | 0      | 0      |
| 330.5.001  | T_CD8            | 330    | 121.2483273    | 31.0298673     | 6.3241939      | 2     | 0     | 0      | 0      |

Notes:
- Gene expression values represent raw transcript counts per cell.
- Only cells belonging to the selected tissue are used during the analysis.
- Only genes listed in `--genes-names-path` are considered.
- Coordinates must be numeric and in micrometers (µm).

---

### 2) Gene list path (`--genes-names-path`) (required)

A plain text file with **one gene name per line**.

Notes:
- Only genes present both in this list and in the labels file are analyzed.
- Genes missing from the labels file are ignored with a warning.
- If no overlap exists, the analysis stops with an error.

Example (`genes_names.txt`):

ACTA2
AGR2
EPCAM
VIM
CD3D
CD3E

---

### Other parameters

- `--out PATH` (required)
  Output directory

- `--tissue TEXT` (optional)
  JSON list of Tissue ID to analyze (string). Example:
  ```bash
  --tissue '["100","313"]'
  ```
  If omitted: uses **all** tissues found in the data.

- `--primary TEXT` (optional)
  JSON list of primary cell types (string). Example:
  ```bash
  --primary '["Endothelial", "T_CD3"]'
  ```
  If omitted: uses **all** cell types found in the tissue.

- `--neighbor TEXT` (optional)
  JSON list of neighbor cell types (string). Example:
  ```bash
  --neighbor '["Epithelial", "Endothelial"]'
  ```
  If omitted: uses **all** cell types found in the tissue.

- `--maximum-distance FLOAT` (optional) (default: `145.0`)
  Maximum spatial distance (in µm). Distances exceeding this threshold are excluded.

- `--leg-threshold FLOAT` (optional) (default: `10.0`)
  Low Expression Gene threshold. Genes with 98th percentile expression ≤ this value are removed.

- `--cell-count-threshold INTEGER` (optional) (default: `20`)
  Minimum number of cells expressing a gene. Genes with fewer expressing cells are removed.

- `--sigma-param FLOAT` (optional) (default: `5.0`)
  Standard deviation for Gaussian smoothing of expression values.

- `--r2-threshold FLOAT` (optional) (default: `0.3`)
  Minimum R² on Gaussian-smoothed data. Genes with lower R² are removed.

- `--num-iterations INTEGER` (optional) (default: `100`)
  Number of permutations for significance testing.

- `--fdr-thresh FLOAT` (optional) (default: `0.05`)
  False discovery rate threshold for global FDR correction.

---

## Examples

### Run all cell types combinations

```bash
insituprep expression-distance run \
  --summary-table-path "data/summary_table.csv" \
  --genes-names-path "data/genes_names.txt" \
  --tissue '["100", "313"]' \
  --out "results/expression_distance_100"
```

### Restrict to specific primary/neighbor lists

```bash
insituprep expression-distance run \
  --summary-table-path "data/summary_table.csv" \
  --genes-names-path "data/genes_names.txt" \
  --tissue '["100"]' \
  --primary '["Endothelial", "T_CD3"]' \
  --neighbor '["Epithelial", "B"]' \
  --out "results/expression_distance_100"
```

### Custom filtering parameters

```bash
insituprep expression-distance run \
  --summary-table-path "data/summary_table.csv" \
  --genes-names-path "data/genes_names.txt" \
  --tissue '["100"]' \
  --primary '["Endothelial"]' \
  --neighbor '["Epithelial"]' \
  --maximum-distance 100 \
  --leg-threshold 5.0 \
  --r2-threshold 0.25 \
  --sigma-param 3.0 \
  --fdr-thresh 0.1 \
  --num-iterations 500 \
  --out "results/expression_distance_100_custom"
```

---

## Output files

All output files are written to the directory provided in `--out`.

This analysis produces:
1. A **combined results table** with all significant genes across all pairs
2. **Heatmaps** showing regression features (slope, FDR, smoothed R²) by tissue
3. **Expression-distance plots** for each significant gene

---

### 1) Final combined results

**Filename**
- `Final_combined_results.csv`

**Meaning**
A comprehensive table containing all genes that passed all filtering steps across all analyzed primary–neighbor pairs and tissues.

**Columns (typical)**

- `gene`  
  Gene name.

- `tissue`  
  Tissue ID.

- `primary_cell_type`  
  The primary cell type (cells whose expression was regressed).

- `neighbor_cell_type`  
  The neighbor cell type (used to compute minimum distances).

- `slope`  
  Linear regression slope (change in expression per unit distance).

- `r2_orig`  
  R² from linear regression on raw expression values.

- `p_value_orig`  
  Nominal p-value from linear regression.

- `p_value_perm`  
  Permutation-based p-value reflecting empirical significance.

- `cells_num`  
  Number of primary cells used for regression (with valid distance and expression data).

- `p98_expression`  
  98th percentile of expression values for this gene in the analyzed cells.

- `p98_distance`  
  98th percentile of minimum distances for the analyzed cells.

- `p_value_fdr_global`  
  Benjamini–Hochberg FDR-adjusted p-value computed globally across all genes, tissues, and pairs.

- `r2_gaussian`  
  R² computed on Gaussian-smoothed expression values.

---

### 2) Heatmaps directory

**Directory**
- `Heatmaps/`

**Meaning**
Contains multi-panel heatmaps for each primary–neighbor pair showing:
- **Slope**: Linear regression slopes (centered colormap).
- **-log10(FDR)**: Negative log10 of global FDR p-values (green colormap).
- **R² Gaussian**: R² values from Gaussian-smoothed regression (blue colormap).

**Filename pattern**
- `combined_heatmap_<PRIMARY>_<NEIGHBOR>.png`

---

### 3) Expression-distance plots directory

**Directory**
- `Plots/`

**Meaning**
Contains detailed expression-distance scatter plots for each significant gene, showing:
- Raw expression vs. distance
- Gaussian-smoothed expression vs. distance
- Permuted (null) comparisons

Each plot includes regression statistics (slope, R², p-value).

**Filename patterns**
- `All_panels_<GENE>_<PRIMARY>_<NEIGHBOR>.png` (6-panel comparison)
- `Raw_panel_<GENE>_<PRIMARY>_<NEIGHBOR>.png` (single raw panel)

---

### 4) Intermediate filtering directories

**Directories**
- `LEGfilter/` — Distribution plots for Low Expression Gene filtering
- `LinearRegression/` — Raw linear regression results before FDR correction
- `FDRfilter/` — FDR filtering summary and filtered results per pair
- `GaussianR2filter/` — Gaussian R² filtering summary and results per pair

